<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4 Zero 2 Creations | Shop Master Pro</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #757575; padding: 20px; color: #333; }
        .container { max-width: 850px; margin: auto; background: #e0e0e0; padding: 35px; border-radius: 15px; box-shadow: 0 4px 25px rgba(0,0,0,0.3); border-top: 10px solid #d32f2f; }
        .logo-area { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #bdbdbd; padding-bottom: 15px; }
        .logo-text { font-size: 24px; text-transform: uppercase; font-weight: bold; margin: 0; color: #212121; }
        .section-label { background: #455a64; color: white; padding: 10px; font-weight: bold; margin-top: 25px; border-radius: 6px; display: block; text-align: center; font-size: 0.8em; text-transform: uppercase; }
        label { font-weight: bold; display: block; margin-top: 15px; font-size: 0.85em; color: #424242; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #9e9e9e; border-radius: 8px; box-sizing: border-box; font-size: 15px; background: #f5f5f5; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        button { width: 100%; padding: 14px; margin-top: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-sync { background: #1976d2; color: white; border-bottom: 4px solid #1565c0; }
        .btn-add { background: #d32f2f; color: white; font-size: 18px; margin-top: 20px; border-bottom: 4px solid #b71c1c; }
        #sync-status { text-align: center; font-size: 12px; margin-top: 8px; font-weight: bold; }
        .grand-total-box { font-size: 2em; background: #fff9c4; padding: 20px; border: 3px solid #fbc02d; text-align: center; border-radius: 12px; margin-top: 20px; }
        table { width: 100%; margin-top: 20px; border-collapse: collapse; background: #eee; border-radius: 8px; overflow: hidden; table-layout: fixed; }
        th { background: #455a64; color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #ccc; word-wrap: break-word; }

        @media print {
            .no-print, button, .section-label, label, input, select, textarea { display: none !important; }
            .container { box-shadow: none !important; border: none !important; width: 100% !important; background: white !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="logo-area"><p class="logo-text">4 Zero 2 Creations</p></div>
    
    <div class="no-print">
        <div class="grid">
            <button class="btn-sync" onclick="fetchAllData()">üîÑ Sync Shop Data</button>
            <button class="btn-add" style="background:#607d8b;" onclick="startNewQuote()">‚ú® New Quote</button>
        </div>
        <div id="sync-status">Status: Ready</div>

        <span class="section-label">1. Job Entry</span>
        <div class="grid">
            <div><label>Process</label>
                <select id="type" onchange="handleProcessChange()">
                    <option value="dtf_full">Full DTF Service</option>
                    <option value="press_only">Heat Press ONLY</option>
                    <option value="transfer_only">DTF Transfer ONLY</option>
                    <option value="laser">Laser Only</option>
                    <option value="hybrid">Hybrid (Laser + Press)</option>
                </select>
            </div>
            <div><label>Item Selection</label><select id="itemSelect" onchange="checkDtfItem()"><option value="">-- Sync First --</option></select></div>
        </div>

        <div id="dtfDimensions" style="display:none; background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid #a5d6a7;">
            <div class="grid">
                <div><label>Width (in)</label><input type="number" id="dtfWidth" value="0" step="0.1"></div>
                <div><label>Height (in)</label><input type="number" id="dtfHeight" value="0" step="0.1"></div>
            </div>
            <label style="color:#2e7d32;">Print/Prep Labor (Total Batch Mins)</label>
            <input type="number" id="prepMins" value="15">
        </div>

        <div id="laserTimeContainer" style="display:none; background: #bbdefb; padding: 15px; border-radius: 8px; margin-top: 10px;">
            <div class="grid">
                <div><label>Module</label><select id="laserModule"><option value="40w">40W</option><option value="2w">2W IR</option></select></div>
                <div><label>Laser Time (Mins)</label><input type="number" id="laserMins" value="10"></div>
            </div>
        </div>

        <div class="grid">
            <div><label>Quantity</label><input type="number" id="qty" value="1"></div>
            <div><label>Setup / Processing Fee?</label>
                <select id="applySetup" onchange="toggleSetupFee()">
                    <option value="no">No</option>
                    <option value="yes">Yes</option>
                </select>
            </div>
        </div>

        <div id="setupFeeContainer" style="display:none; background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid #ffcc80;">
            <div class="grid">
                <div><label>Manual Fee ($)</label><input type="number" id="manualSetupFee" value="0.00" step="0.01"></div>
                <div><label>Example Pricing Guide</label><select id="feeExample" onchange="applyFeeExample()"><option value="0">-- Select Example --</option></select></div>
            </div>
        </div>

        <button class="btn-add" id="mainActionButton" onclick="handleMainAction()">‚ûï Add Item to Quote</button>
    </div>

    <div id="resultBox" style="display:none;">
        <table id="quoteTable">
            <thead><tr><th>Details</th><th>Qty</th><th>Total</th><th class="no-print">X</th></tr></thead>
            <tbody id="quoteBody"></tbody>
        </table>
        <div class="grand-total-box"><strong>Total: $<span id="grandTotal">0.00</span></strong></div>
        <div class="grid no-print"><button onclick="window.print()">üñ®Ô∏è Print Quote</button></div>
    </div>
</div>

<script>
let catalogData = [], shopRates = {}, feeExamples = [], quoteItems = [];
const catalogUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8ZvjITchUAB_1BPehZcfFFq4ZHqyQBfGZxa71wQz3b9JHHZBCnC9roKjfrRCnUdJbkp0prPDZDfXO/pub?output=csv";
const settingsUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8ZvjITchUAB_1BPehZcfFFq4ZHqyQBfGZxa71wQz3b9JHHZBCnC9roKjfrRCnUdJbkp0prPDZDfXO/pub?gid=1511041891&single=true&output=csv"; 
const feesUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8ZvjITchUAB_1BPehZcfFFq4ZHqyQBfGZxa71wQz3b9JHHZBCnC9roKjfrRCnUdJbkp0prPDZDfXO/pub?gid=413242066&single=true&output=csv"; 
const proxy = "https://corsproxy.io/?";

async function fetchAllData() {
    document.getElementById('sync-status').innerText = "‚åõ Syncing...";
    try {
        const [cat, set, fee] = await Promise.all([
            fetch(proxy + encodeURIComponent(catalogUrl)).then(r => r.text()),
            fetch(proxy + encodeURIComponent(settingsUrl)).then(r => r.text()),
            fetch(proxy + encodeURIComponent(feesUrl)).then(r => r.text())
        ]);

        catalogData = cat.split('\n').filter(r => r.trim() !== '').slice(1).map(r => {
            const c = r.split(','); return { name: c[0].replace(/"/g, "").trim(), price: parseFloat(c[1]) || 0 };
        });

        set.split('\n').filter(r => r.trim() !== '').forEach(r => {
            const c = r.split(','); shopRates[c[0].trim()] = parseFloat(c[1]);
        });

        const feeSelect = document.getElementById('feeExample');
        feeSelect.innerHTML = '<option value="0">-- Example Pricing --</option>';
        fee.split('\n').filter(r => r.trim() !== '').slice(1).forEach(r => {
            const c = r.split(',');
            const opt = document.createElement('option');
            opt.value = parseFloat(c[1]) || 0;
            opt.text = `${c[0].replace(/"/g, "")} ($${opt.value})`;
            feeSelect.add(opt);
        });

        const select = document.getElementById('itemSelect');
        select.innerHTML = '<option value="">-- Select Item --</option>';
        catalogData.forEach((item, i) => {
            const opt = document.createElement('option'); opt.value = i; opt.text = `${item.name} ($${item.price.toFixed(2)})`; select.add(opt);
        });
        document.getElementById('sync-status').innerText = "‚úÖ Ready";
    } catch (e) { document.getElementById('sync-status').innerText = "‚ùå Sync Error"; }
}

function toggleSetupFee() {
    document.getElementById('setupFeeContainer').style.display = document.getElementById('applySetup').value === 'yes' ? 'block' : 'none';
}

function applyFeeExample() {
    document.getElementById('manualSetupFee').value = document.getElementById('feeExample').value;
}

function checkDtfItem() {
    const itmText = catalogData[document.getElementById('itemSelect').value]?.name || "";
    document.getElementById('dtfDimensions').style.display = itmText.toUpperCase().includes("DTF") ? 'block' : 'none';
}

function handleProcessChange() {
    const type = document.getElementById('type').value;
    document.getElementById('laserTimeContainer').style.display = (type === 'laser' || type === 'hybrid') ? 'block' : 'none';
}

function calculateBaseLineCost() {
    const itm = catalogData[document.getElementById('itemSelect').value];
    const qty = parseInt(document.getElementById('qty').value) || 1;
    const process = document.getElementById('type').value;
    const laborMin = (shopRates.Labor_Rate || 30) / 60;
    const markup = shopRates.Markup || 1;

    let materialCost = 0;
    if (process !== 'press_only') {
        if (itm.name.toUpperCase().includes("DTF")) {
            const w = parseFloat(document.getElementById('dtfWidth').value) || 0;
            const h = parseFloat(document.getElementById('dtfHeight').value) || 0;
            materialCost = (w * h) * itm.price * qty;
        } else {
            materialCost = itm.price * qty;
        }
    }

    let laborCost = 0;
    if (process.includes('dtf') || process === 'transfer_only') laborCost += (parseFloat(document.getElementById('prepMins').value) || 0) * laborMin;
    if (process === 'laser' || process === 'hybrid') {
        const laserRate = (document.getElementById('laserModule').value === '40w') ? shopRates.Diode_Rate : shopRates.IR_Rate;
        laborCost += (parseFloat(document.getElementById('laserMins').value) || 0) * (laborMin + (laserRate || 0));
    }
    if (process === 'dtf_full' || process === 'press_only' || process === 'hybrid') laborCost += (6 * qty * laborMin);

    return (materialCost * markup) + laborCost;
}

function handleMainAction() {
    if (document.getElementById('itemSelect').value === "") return alert("Select an item!");
    const itmText = catalogData[document.getElementById('itemSelect').value].name;
    const process = document.getElementById('type').value.toUpperCase();
    
    // Line Item Cost
    const lineCost = calculateBaseLineCost();
    quoteItems.push({ desc: `${itmText} [${process}]`, qty: document.getElementById('qty').value, total: lineCost });
    
    // Add Setup Fee as its own line item if selected
    if (document.getElementById('applySetup').value === 'yes') {
        const feeAmt = parseFloat(document.getElementById('manualSetupFee').value) || 0;
        const feeDesc = document.getElementById('feeExample').options[document.getElementById('feeExample').selectedIndex].text.split(' ($')[0];
        quoteItems.push({ desc: `Processing Fee: ${feeDesc === '-- Select Example --' ? 'Custom Design/Prep' : feeDesc}`, qty: 1, total: feeAmt });
        // Reset setup fee dropdown so it doesn't add it twice by accident
        document.getElementById('applySetup').value = 'no';
        toggleSetupFee();
    }
    
    renderQuote();
}

function renderQuote() {
    const body = document.getElementById('quoteBody'); body.innerHTML = ""; let grandTotal = 0;
    quoteItems.forEach((item, index) => { 
        grandTotal += item.total; 
        body.innerHTML += `<tr><td>${item.desc}</td><td>${item.qty}</td><td>$${item.total.toFixed(2)}</td><td class="no-print"><button onclick="removeItem(${index})">X</button></td></tr>`; 
    });
    document.getElementById('grandTotal').innerText = grandTotal.toFixed(2);
    document.getElementById('resultBox').style.display = quoteItems.length > 0 ? "block" : "none";
}

function startNewQuote() { quoteItems = []; renderQuote(); }
function removeItem(index) { quoteItems.splice(index, 1); renderQuote(); }
window.onload = fetchAllData;
</script>
</body>
</html>
