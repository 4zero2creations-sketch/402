<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4 Zero 2 Creations | Shop Master Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Eye-Saver Medium Grey Theme */
        body { font-family: 'Segoe UI', sans-serif; background: #757575; padding: 20px; color: #333; }
        .container { max-width: 850px; margin: auto; background: #e0e0e0; padding: 35px; border-radius: 15px; box-shadow: 0 4px 25px rgba(0,0,0,0.3); border-top: 10px solid #d32f2f; }
        
        .logo-area { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #bdbdbd; padding-bottom: 15px; }
        .logo-4 { font-size: 80px; font-weight: 900; color: #d32f2f; line-height: 1; margin: 0; }
        .logo-text { font-size: 24px; text-transform: uppercase; font-weight: bold; margin: 0; color: #212121; }
        
        .section-label { background: #455a64; color: white; padding: 10px; font-weight: bold; margin-top: 25px; border-radius: 6px; display: block; text-align: center; font-size: 0.8em; text-transform: uppercase; }
        label { font-weight: bold; display: block; margin-top: 15px; font-size: 0.85em; color: #424242; }
        
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #9e9e9e; border-radius: 8px; box-sizing: border-box; font-size: 15px; background: #f5f5f5; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        button { width: 100%; padding: 14px; margin-top: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-sync { background: #1976d2; color: white; border-bottom: 4px solid #1565c0; }
        .btn-add { background: #d32f2f; color: white; font-size: 18px; margin-top: 20px; border-bottom: 4px solid #b71c1c; }
        .btn-pdf { background: #546e7a; color: white; }
        .btn-record { background: #ff9800; color: white; border-bottom: 4px solid #e68a00; }
        .btn-clear { background: #78909c; color: white; margin-top: 10px; font-size: 12px; padding: 8px; width: auto; float: right; }
        .btn-remove { background: #c62828; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* Quote Summary Table */
        table { width: 100%; margin-top: 20px; border-collapse: collapse; background: #eee; border-radius: 8px; overflow: hidden; }
        th { background: #455a64; color: white; padding: 12px; text-align: left; font-size: 0.8em; }
        td { padding: 12px; border-bottom: 1px solid #ccc; font-size: 0.9em; }
        
        .grand-total-box { font-size: 2em; background: #fff9c4; padding: 20px; border: 3px solid #fbc02d; text-align: center; border-radius: 12px; margin-top: 20px; }
        .adj-box { background: #cfd8dc; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #b0bec5; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: center; }
        .adj-group { display: flex; align-items: center; gap: 8px; justify-content: center; }
        .adj-input { width: 70px !important; text-align: center; padding: 8px !important; margin: 0 !important; }
        
        #sync-status { font-size: 12px; text-align: center; margin-top: 8px; color: #1b5e20; font-weight: bold; }
        .no-print { width: 40px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div class="logo-area"><p class="logo-4">4</p><p class="logo-text">4 Zero 2 Creations</p></div>

    <button class="btn-sync" onclick="fetchAllData()">ðŸ”„ Sync All Shop Data</button>
    <div id="sync-status">Status: Ready</div>

    <span class="section-label">1. Customer Info</span>
    <label>Customer Name</label>
    <input type="text" id="custName" placeholder="Enter Name">

    <span class="section-label">2. Add Item to Order</span>
    <div class="grid">
        <div>
            <label>Process</label>
            <select id="type" onchange="toggleModule()">
                <option value="dtf">Heat Press / DTF</option>
                <option value="laser">Laser Only</option>
            </select>
        </div>
        <div>
            <label>Laser Module</label>
            <select id="laserModule">
                <option value="40w">40W Diode (S1)</option>
                <option value="2w">2W IR (S1)</option>
            </select>
        </div>
    </div>

    <div class="grid">
        <div><label>Item Selection</label><select id="itemSelect"><option value="">-- Sync First --</option></select></div>
        <div><label>Apply Setup Fee?</label><select id="applySetup"><option value="no">No</option><option value="yes">Yes</option></select></div>
    </div>

    <label>Item Specific Notes</label>
    <textarea id="jobNotes" placeholder="e.g. XL Hoodie, Silver logo on sleeve..." style="height:60px;"></textarea>

    <div style="background: #bbdefb; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #90caf9;">
        <input type="checkbox" id="addLaser" onchange="calculateItemPreview()"> <strong>Add Laser Element (e.g. Patch)</strong>
        <div id="laserDetails" style="display:none; margin-top:10px;">
            <label>Laser Machine Time (Minutes)</label>
            <input type="number" id="laserMins" value="10">
        </div>
    </div>

    <div class="grid" style="margin-top:15px;">
        <div><label>Quantity</label><input type="number" id="qty" value="1"></div>
        <div><label>Sourcing</label><select id="provided"><option value="no">Shop Provides</option><option value="yes">Customer Provides</option></select></div>
    </div>

    <button class="btn-add" onclick="addItemToQuote()">âž• Add Item to Quote</button>

    <span class="section-label">3. Live Quote Summary</span>
    <div id="resultBox" style="display:none;">
        <button class="btn-clear" onclick="clearQuote()">Reset Quote</button>
        <div id="pdf-content">
            <h2 style="color:#d32f2f; margin:0; text-align: center;">Quote for: <span id="outName"></span></h2>
            <p style="text-align:center; font-size: 0.8em; margin: 5px 0;">Date: <span id="quoteDate"></span></p>
            <table id="quoteTable">
                <thead>
                    <tr>
                        <th>Item & Notes</th>
                        <th>Qty</th>
                        <th>Total</th>
                        <th class="no-print"></th>
                    </tr>
                </thead>
                <tbody id="quoteBody"></tbody>
            </table>
            <div class="grand-total-box">
                <div id="final-discount-line" style="color: #d32f2f; font-size: 0.4em; font-weight:bold;"></div>
                <div id="tax-line" style="font-size: 0.4em; color: #455a64;"></div>
                <strong>Grand Total: $<span id="grandTotal">0.00</span></strong>
            </div>
        </div>

        <div class="adj-box">
            <div class="adj-group">
                <strong>Discount:</strong> 
                <input type="number" id="manualDiscount" class="adj-input" value="0" oninput="renderQuote()"> <strong>%</strong>
            </div>
            <div class="adj-group">
                <input type="checkbox" id="applyTax" class="tax-checkbox" onchange="renderQuote()">
                <strong>Tax:</strong>
                <input type="number" id="taxOverride" class="adj-input" value="7.5" step="0.1" oninput="renderQuote()"> <strong>%</strong>
            </div>
        </div>

        <button class="btn-pdf" onclick="savePDF()">Download PDF</button>
        <button class="btn-record" onclick="recordQuote()">ðŸ’¾ Record Order to Spreadsheet</button>
    </div>
</div>

<script>
let catalogData = [];
let shopRates = {};
let quoteItems = [];

const catalogUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8ZvjITchUAB_1BPehZcfFFq4ZHqyQBfGZxa71wQz3b9JHHZBCnC9roKjfrRCnUdJbkp0prPDZDfXO/pub?output=csv";
const settingsUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8ZvjITchUAB_1BPehZcfFFq4ZHqyQBfGZxa71wQz3b9JHHZBCnC9roKjfrRCnUdJbkp0prPDZDfXO/pub?gid=1511041891&single=true&output=csv"; 
const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLScuEZvj-nmCo22JDcq94BxLsUcKHa8uN9hC6UqxjB8r6ZeBfg/viewform?usp=pp_url";
const proxy = "https://corsproxy.io/?";

async function fetchAllData() {
    document.getElementById('sync-status').innerText = "âŒ› Syncing Catalog & Rates...";
    try {
        const catRes = await fetch(proxy + encodeURIComponent(catalogUrl));
        const catData = await catRes.text();
        const catRows = catData.split('\n').filter(r => r.trim() !== '').slice(1);
        catalogData = catRows.map(r => { const c = r.split(','); return { name: c[0].replace(/"/g, ""), price: parseFloat(c[1]) || 0 }; });

        const setRes = await fetch(proxy + encodeURIComponent(settingsUrl));
        const setData = await setRes.text();
        const setRows = setData.split('\n').filter(r => r.trim() !== '');
        setRows.forEach(r => {
            const c = r.split(',');
            shopRates[c[0].trim()] = parseFloat(c[1]);
        });

        // Load spreadsheet tax rate into override box
        if (shopRates.Tax_Rate) document.getElementById('taxOverride').value = (shopRates.Tax_Rate * 100).toFixed(1);

        const select = document.getElementById('itemSelect');
        select.innerHTML = "";
        catalogData.forEach((item, i) => {
            const opt = document.createElement('option'); opt.value = i;
            opt.text = `${item.name} ($${item.price.toFixed(2)})`; select.add(opt);
        });

        document.getElementById('sync-status').innerText = "âœ… Full Shop Sync Complete";
    } catch (e) { document.getElementById('sync-status').innerText = "âŒ Sync Error"; }
}

function addItemToQuote() {
    const itemIdx = document.getElementById('itemSelect').value;
    if (itemIdx === "" || !shopRates.Markup) return alert("Please Sync First.");

    const item = catalogData[itemIdx];
    const qty = parseInt(document.getElementById('qty').value);
    const type = document.getElementById('type').value;
    const module = document.getElementById('laserModule').value;
    const notes = document.getElementById('jobNotes').value || "Standard";
    const setupUsed = document.getElementById('applySetup').value === 'yes';

    // Calculation Engine
    const watts = (module === '40w') ? shopRates.Diode_Watts : shopRates.IR_Watts;
    const lRate = (module === '40w') ? shopRates.Diode_Rate : shopRates.IR_Rate;
    let baseCost = (document.getElementById('provided').value === 'no') ? item.price : 1.50;
    const powerCost = (w, m) => (w / 1000) * (m / 60) * shopRates.kWh_Rate;

    if (type === 'dtf') {
        baseCost += (6 * (shopRates.Labor_Rate / 60)) + powerCost(shopRates.Press_Watts, 6) + 1.50;
    } else {
        baseCost += (15 * lRate) + powerCost(watts, 15);
    }

    if (document.getElementById('addLaser').checked) {
        document.getElementById('laserDetails').style.display = 'block';
        const lm = parseFloat(document.getElementById('laserMins').value);
        baseCost += 2.00 + (lm * (lRate + (shopRates.Labor_Rate / 60))) + powerCost(watts, lm);
    }

    let itemTotal = (baseCost * shopRates.Markup) * qty;
    if (setupUsed) itemTotal += shopRates.Setup_Fee;

    quoteItems.push({ desc: `${item.name} - ${notes}`, qty: qty, total: itemTotal });
    renderQuote();
    document.getElementById('jobNotes').value = ""; 
}

function renderQuote() {
    const body = document.getElementById('quoteBody');
    body.innerHTML = "";
    let subTotal = 0;
    quoteItems.forEach((item, index) => {
        subTotal += item.total;
        body.innerHTML += `<tr><td>${item.desc}</td><td>${item.qty}</td><td>$${item.total.toFixed(2)}</td><td class="action-col no-print"><button class="btn-remove" onclick="removeItem(${index})">X</button></td></tr>`;
    });

    const manualPct = parseFloat(document.getElementById('manualDiscount').value) || 0;
    const discountAmount = subTotal * (manualPct / 100);
    const discountedSubtotal = subTotal - discountAmount;

    let taxAmount = 0;
    const taxRate = parseFloat(document.getElementById('taxOverride').value) / 100;
    if (document.getElementById('applyTax').checked) taxAmount = discountedSubtotal * taxRate;

    const finalTotal = discountedSubtotal + taxAmount;

    document.getElementById('quoteDate').innerText = new Date().toLocaleDateString();
    document.getElementById('final-discount-line').innerText = manualPct > 0 ? `Discount (${manualPct}%): -$${discountAmount.toFixed(2)}` : "";
    document.getElementById('tax-line').innerText = taxAmount > 0 ? `Tax (${(taxRate*100).toFixed(1)}%): +$${taxAmount.toFixed(2)}` : "";
    document.getElementById('grandTotal').innerText = finalTotal.toFixed(2);
    document.getElementById('outName').innerText = document.getElementById('custName').value || "Customer";
    document.getElementById('resultBox').style.display = quoteItems.length > 0 ? "block" : "none";
}

function removeItem(index) { quoteItems.splice(index, 1); renderQuote(); }
function clearQuote() { if(confirm("Clear Order?")) { quoteItems = []; renderQuote(); } }

function recordQuote() {
    const name = encodeURIComponent(document.getElementById('custName').value);
    const taxVal = document.getElementById('taxOverride').value;
    const taxStatus = document.getElementById('applyTax').checked ? `[Tax ${taxVal}%]` : "[Tax Exempt]";
    let summary = quoteItems.map(i => `${i.qty}x ${i.desc}`).join(" | ") + " " + taxStatus;
    const total = encodeURIComponent(document.getElementById('grandTotal').innerText);
    window.open(`${formUrl}&entry.1592314545=${name}&entry.1989487532=${encodeURIComponent(summary)}&entry.101375962=Multiple&entry.1075677943=${total}`, '_blank');
}

function savePDF() {
    const elements = document.getElementsByClassName('no-print');
    for (let el of elements) el.style.display = 'none';
    html2pdf().from(document.getElementById('pdf-content')).save('402_Quote.pdf').then(() => {
        for (let el of elements) el.style.display = 'table-cell';
    });
}

function toggleModule() {
    document.getElementById('laserModule').disabled = (document.getElementById('type').value === 'dtf');
    document.getElementById('laserDetails').style.display = (document.getElementById('addLaser').checked) ? 'block' : 'none';
}

window.onload = fetchAllData;
</script>
</body>
</html>
