<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4 Zero 2 Creations | Shop Master Pro</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #333; padding: 20px; color: #333; }
        .container { max-width: 850px; margin: auto; background: #eee; padding: 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border-top: 10px solid #d32f2f; }
        .logo-text { font-size: 28px; text-transform: uppercase; font-weight: 800; text-align: center; display: block; margin-bottom: 20px; color: #111; border-bottom: 2px solid #ccc; padding-bottom: 10px; }
        
        .card { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd; }
        .card-title { font-size: 0.85em; font-weight: 900; color: #d32f2f; text-transform: uppercase; margin-bottom: 15px; display: block; border-left: 5px solid #d32f2f; padding-left: 12px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { font-weight: bold; font-size: 0.85em; display: block; margin-bottom: 5px; color: #444; }
        input, select { width: 100%; padding: 12px; border: 1px solid #bbb; border-radius: 6px; box-sizing: border-box; font-size: 15px; background: #fafafa; }
        
        button { cursor: pointer; font-weight: bold; text-transform: uppercase; border-radius: 6px; border: none; transition: 0.2s; }
        .btn-sync { background: #1976d2; color: white; padding: 10px 20px; font-size: 0.8em; border-bottom: 3px solid #0d47a1; }
        .btn-add { background: #d32f2f; color: white; padding: 18px; width: 100%; font-size: 1.1em; margin-top: 10px; border-bottom: 5px solid #b71c1c; }
        .btn-edit { background: #1976d2; color: white; padding: 5px 10px; }
        .btn-remove { background: #c62828; color: white; padding: 5px 10px; }
        
        .grand-total-box { font-size: 2.2em; text-align: center; padding: 25px; background: #fff9c4; border: 3px solid #fbc02d; border-radius: 10px; margin-top: 20px; }
        
        @media print {
            .no-print, button, .card-title { display: none !important; }
            .container { box-shadow: none !important; border: none !important; width: 100% !important; background: white !important; }
            th:last-child, td:last-child { display: none !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="logo-text">4 Zero 2 Creations</div>

    <div class="no-print">
        <div class="card">
            <span class="card-title">1. Customer & Sourcing</span>
            <div class="grid">
                <input type="text" id="custName" placeholder="Customer Name">
                <select id="sourcing"><option value="shop">Shop Provides Blank</option><option value="cust">Customer Provides Blank</option></select>
            </div>
            <button class="btn-sync" style="margin-top:15px;" onclick="fetchAllData()">üîÑ Sync All Shop Data</button>
            <div id="sync-status" style="text-align:center; font-size:11px; margin-top:5px;">Ready</div>
        </div>

        <div class="card">
            <span class="card-title">2. Job Builder</span>
            <div class="grid">
                <div><label>Process Type</label>
                    <select id="process" onchange="updateUI()">
                        <option value="dtf_full">Full DTF Service (Standard Order)</option>
                        <option value="press_only">Heat Press ONLY (Customer Provided)</option>
                        <option value="transfer_only">Transfer ONLY (Film Sale)</option>
                        <option value="laser">Laser Only</option>
                        <option value="hybrid">Hybrid (Laser Patch + Press)</option>
                    </select>
                </div>
                <div><label>Quantity</label><input type="number" id="qty" value="1"></div>
            </div>

            <div id="blankRow" style="margin-top:15px;">
                <label>Select Blank (Shirt/Hoodie/Hat)</label>
                <div class="grid">
                    <select id="blankSelect"><option value="">-- Select --</option></select>
                    <input type="text" id="itemSize" placeholder="Size (XL, etc.)">
                </div>
            </div>

            <div id="decoRow" style="margin-top:15px;">
                <label>Decoration (Transfer/Material)</label>
                <div class="grid">
                    <select id="transferSelect"><option value="">-- Select --</option></select>
                    <div style="display:flex; gap:5px;"><input type="number" id="w" placeholder="W" step="0.1"><input type="number" id="h" placeholder="H" step="0.1"></div>
                </div>
            </div>

            <div id="laserRow" style="margin-top:15px; display:none;">
                <label>Laser Settings</label>
                <div class="grid">
                    <select id="laserModule"><option value="40w">40W Diode</option><option value="2w">2W IR</option></select>
                    <input type="number" id="laserMins" placeholder="Run Mins">
                </div>
            </div>

            <button class="btn-add" onclick="handleMainAction()">‚ûï Add to Quote</button>
        </div>
    </div>

    <div id="resultBox" style="display:none;">
        <div class="card">
            <table id="quoteTable">
                <thead><tr><th>Description</th><th>Qty</th><th>Total</th><th class="no-print">X</th></tr></thead>
                <tbody id="quoteBody"></tbody>
            </table>
            <div class="grand-total-box"><strong>TOTAL: $<span id="grandTotal">0.00</span></strong></div>
            <div class="no-print" style="margin-top:15px;"><button onclick="window.print()">üñ®Ô∏è Print Quote</button></div>
        </div>
    </div>
</div>

<script>
let blanks = [], transfers = [], shopRates = {}, quoteItems = [];
const proxy = "https://corsproxy.io/?";
const base = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8ZvjITchUAB_1BPehZcfFFq4ZHqyQBfGZxa71wQz3b9JHHZBCnC9roKjfrRCnUdJbkp0prPDZDfXO/pub?output=csv";
const urls = { blanks: base, settings: base + "&gid=1511041891&single=true", transfers: base + "&gid=1573687412&single=true" };

async function fetchAllData() {
    try {
        const [b, s, t] = await Promise.all(Object.values(urls).map(url => fetch(proxy + encodeURIComponent(url)).then(r => r.text())));
        blanks = b.split('\n').slice(1).map(r => { const c = r.split(','); return { n: c[0].replace(/"/g, "").trim(), p: parseFloat(c[1]) || 0 }; });
        transfers = t.split('\n').slice(1).map(r => { const c = r.split(','); return { n: c[0].replace(/"/g, "").trim(), p: parseFloat(c[1]) || 0 }; });
        s.split('\n').forEach(r => { const c = r.split(','); shopRates[c[0].trim()] = parseFloat(c[1]); });
        fillSelect('blankSelect', blanks); fillSelect('transferSelect', transfers);
        document.getElementById('sync-status').innerText = "‚úÖ Data Ready";
    } catch (e) { alert("Sync Failed!"); }
}

function fillSelect(id, data) {
    const s = document.getElementById(id); s.innerHTML = '<option value="">-- Select --</option>';
    data.forEach((item, i) => { const o = document.createElement('option'); o.value = i; o.text = `${item.n} ($${item.p})`; s.add(o); });
}

function updateUI() {
    const p = document.getElementById('process').value;
    document.getElementById('blankRow').style.display = (p === 'transfer_only' || p === 'laser') ? 'none' : 'block';
    document.getElementById('decoRow').style.display = (p === 'press_only') ? 'none' : 'block';
    document.getElementById('laserRow').style.display = (p === 'laser' || p === 'hybrid') ? 'block' : 'none';
}

function calculateCost() {
    const p = document.getElementById('process').value, q = parseInt(document.getElementById('qty').value) || 1;
    const markup = shopRates.Markup || 1, laborMin = (shopRates.Labor_Rate || 30) / 60;
    const printerRate = (shopRates.Printer_Rate || 0) / 60;
    const kwRate = 0.12 / 60; // Assumed $0.12/kWh converted to per minute
    const pressPower = ((shopRates.Press_Watts || 1500) / 1000) * kwRate;
    const pressWear = shopRates.Press_Rate || 0; // $/min for wear
    
    let mat = 0;
    if (p !== 'press_only') {
        const bIdx = document.getElementById('blankSelect').value, tIdx = document.getElementById('transferSelect').value;
        const bCost = (document.getElementById('sourcing').value === 'shop' && bIdx !== "") ? blanks[bIdx].p : 0;
        const w = parseFloat(document.getElementById('w').value) || 0, h = parseFloat(document.getElementById('h').value) || 0;
        const tCost = (tIdx !== "") ? (w * h * transfers[tIdx].p) : 0;
        mat = (bCost + tCost) * markup * q;
    }

    let labor = 0;
    if (p.includes('dtf') || p === 'transfer_only') labor += (15 * (laborMin + printerRate));
    if (p === 'dtf_full' || p === 'press_only' || p === 'hybrid') labor += (6 * q * (laborMin + pressPower + pressWear));
    if (p === 'laser' || p === 'hybrid') {
        const lRate = (document.getElementById('laserModule').value === '40w' ? shopRates.Diode_Rate : shopRates.IR_Rate) || 0;
        labor += (parseFloat(document.getElementById('laserMins').value) || 0) * (laborMin + lRate);
    }
    return mat + labor;
}

function handleMainAction() {
    const p = document.getElementById('process').value, bIdx = document.getElementById('blankSelect').value;
    const tIdx = document.getElementById('transferSelect').value, size = document.getElementById('itemSize').value;
    let desc = "";
    if (p === 'press_only') desc = "Heat Press Labor (Customer Provided)";
    else {
        if (bIdx !== "") desc += blanks[bIdx].n + (size ? ` [${size}]` : "");
        if (tIdx !== "") desc += ` w/ ${document.getElementById('w').value}x${document.getElementById('h').value} ${transfers[tIdx].n}`;
    }
    quoteItems.push({ desc, qty: document.getElementById('qty').value, total: calculateCost() });
    renderQuote();
}

function renderQuote() {
    const body = document.getElementById('quoteBody'); body.innerHTML = ""; let grand = 0;
    quoteItems.forEach((item, i) => { grand += item.total; body.innerHTML += `<tr><td>${item.desc}</td><td>${item.qty}</td><td>$${item.total.toFixed(2)}</td><td class="no-print"><button onclick="remove(${i})" class="btn-remove">X</button></td></tr>`; });
    document.getElementById('grandTotal').innerText = grand.toFixed(2);
    document.getElementById('resultBox').style.display = quoteItems.length > 0 ? "block" : "none";
}

function remove(i) { quoteItems.splice(i, 1); renderQuote(); }
window.onload = fetchAllData;
</script>
</body>
</html>
